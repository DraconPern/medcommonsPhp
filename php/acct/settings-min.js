function SettingsTableManager(cfg){this.cfg=cfg;this.ds=null;this.dt=null;var yevt=YAHOO.util.Event;var mgr=this;this.init=function(){log("init table manager");var nameDef=null;var columnDefs=[nameDef={key:"name",label:"Name",sortable:true},{key:"email",label:"Email",sortable:true},{key:"accid",label:"Account ID",sortable:true},{key:"accid",label:"<img id='delete"+this.cfg.type+"MemberImg' onclick='__"+cfg.type+"_delete()' class='clickable' title='Delete Checked Entries' src='images/trash.gif'/>",formatter:function(cell,record,col,data){cell.innerHTML='<input type="checkbox" value="'+data+'"/>'},sortable:false}];if(this.cfg.nameFormatter){nameDef.formatter=this.cfg.nameFormatter}window["__"+cfg.type+"_delete"]=function(){mgr.deleteMember()};this.ds=new YAHOO.util.DataSource(this.getUrl());this.ds.responseType=YAHOO.util.DataSource.TYPE_JSON;this.ds.responseSchema={resultsList:"members",fields:["name","email","accid"]};try{var tableProperties={scrollable:false,width:"100%",height:"14em"};if(this.cfg.formatRow){tableProperties.formatRow=this.cfg.formatRow}this.dt=new YAHOO.widget.DataTable(this.cfg.type+"Container",columnDefs,this.ds,tableProperties)}catch(e){dumpProperties("Failed to display table",e)}yevt.addListener("add"+this.cfg.type+"MemberButton","click",function(){mgr.checkAdd()});yuiLoader()};this.requery=function(){mgr.ds.liveData=mgr.getUrl();mgr.ds.sendRequest("",{success:mgr.dt.onDataReturnInitializeTable,scope:mgr.dt})};this.checkAdd=function(){var accid=$(mgr.cfg.addElementId).value.replace(/[# -]/g,"");if(accid==""){alert("Please enter a 16 digit account id to add to the Group");$(cfg.addElementId).focus();return }if(!accid.match(/^[0-9]{16}$/)){alert("Your entry did not match the expected format. Account IDs are 16 digit numbers.\n\nPlease adjust your entry and try again.");$(cfg.addElementId).focus();$(cfg.addElementId).select();return }var trs=mgr.dt.getBody().getElementsByTagName("tr");var dupe=null;for(var i=0;i<trs.length;++i){var tr=trs[i];if(tr.id){var rec=mgr.dt.getRecordSet().getRecord(tr.id).getData();if(rec.accid==accid){$(cfg.type+"msg").innerHTML="This account is already in your "+cfg.tableDesc+".";if(YAHOO.env.ua.ie>0){YAHOO.util.Dom.addClass(tr,"highlight")}else{var oldColor=YAHOO.util.Dom.getStyle(tr,"backgroundColor");var anim=new YAHOO.util.ColorAnim(tr,{backgroundColor:{to:"#ffd490"}},0.3);anim.onComplete.subscribe(function(){this.attributes.backgroundColor.to=oldColor;this.onComplete.unsubscribeAll();this.animate()});anim.animate()}dupe=tr}else{YAHOO.util.Dom.removeClass(tr,"highlight")}}}if(dupe){return }cfg.onAdd(accid)};this.deleteMember=function(){var checks=$(cfg.containerId).getElementsByTagName("input");var checked=[];for(var i=0;i<checks.length;++i){var c=checks[i];if(c.checked){checked.push(c.value)}}if(checked.length==0){alert("Please select one or more entries to delete!");return }if(cfg.onBeforeDelete&&!cfg.onBeforeDelete(checked)){return }var url=cfg.deleteUrl+"?enc="+hex_sha1(getCookie("mc"));YAHOO.util.Connect.asyncRequest("POST",url,{success:function(req,resp,payload){var obj=eval("x = "+req.responseText);if(obj.status=="ok"){if(cfg.onDeleteSuccess){cfg.onDeleteSuccess(checked)}mgr.requery()}else{alert("An error occurred while deleting the "+cfg.type+": "+obj.error)}}},"accid="+encodeURIComponent(checked.join(",")))};this.getUrl=function(){return mgr.cfg.url+"?enc="+hex_sha1(getCookie("mc"))+"&rand="+hex_sha1("x"+Math.random()+""+(new Date().getTime()))+"x&"}}var el=function(B,A){B=new YAHOO.util.Element(B,A);YAHOO.lang.augmentObject(B.DOM_EVENTS,{change:true,focus:true,blur:true});return B};var addressTableManager=null;function initAddresses(){addressTableManager=new SettingsTableManager({type:"address",url:"addresses.php",addElementId:"accid",tableDesc:"addresss book",onAdd:confirmAddAddress,containerId:"addressContainer",deleteUrl:"delete_address.php"});addressTableManager.init()}function confirmAddAddress(C){var A="query_address_details.php?accid="+encodeURIComponent(C)+"&enc="+hex_sha1(getCookie("mc"));var B=YAHOO.util.Connect.asyncRequest("GET",A,{success:function(D,F,E){if(D.responseText.match(/^\s*Failed\s*$/)){alert("The account you entered could not be found.\n\nPlease check your entry and try again.");return }yuiLoader().insert(function(){var G=new YAHOO.widget.SimpleDialog("confirmAddressDlg",{width:"500px",fixedcenter:true,modal:true,visible:true,draggable:true,buttons:[{text:"OK - Add this Address",handler:function(){addAddress(C,this)}},{text:"Cancel",handler:function(){this.destroy()}}]});G.setHeader("Add Address - Confirmation");G.setBody("<p>Do you want to add the following address to your Address Book?</p><br/>"+D.responseText);G.render(document.body)})}})}function addAddress(accid,dlg){var accid=$("accid").value.replace(/[# -]/g,"");$("addressmsg").innerHTML="";var url="add_address.php?enc="+hex_sha1(getCookie("mc"))+"&accid="+encodeURIComponent(accid);var transaction=YAHOO.util.Connect.asyncRequest("GET",url,{success:function(req,resp,payload){var obj=eval("x = "+req.responseText);if(obj.status!="ok"){alert("An error occurred while adding the address: "+obj.error)}else{$("accid").value="";addressTableManager.requery()}dlg.destroy()}},null);return false}var groupTableManager=null;function initGroups(){groupTableManager=new SettingsTableManager({type:"group",url:"query_groups.php",addElementId:"maccid",tableDesc:"group",onAdd:confirmAddGroup,containerId:"groupContainer",deleteUrl:"delete_group_member.php",onBeforeDelete:checkDeleteSelf,onDeleteSuccess:checkSelfDeleted,formatRow:formatGroupMemberRow,nameFormatter:function(B,C,D,E){if(C.getData("name")==null){B.innerHTML="Invitation Sent"}else{YAHOO.widget.DataTable.formatText(B,C,D,E)}}});groupTableManager.init();var A=YAHOO.util.Event;A.addListener("inviteGroupMemberButton","click",inviteGroupMember)}function formatGroupMemberRow(A,B){if(B.getData("name")==null){YAHOO.util.Dom.addClass(A,"pending")}return true}function inviteGroupMember(){yuiLoader().insert(function(){var B=new YAHOO.widget.SimpleDialog("inviteEmailsDlg",{width:"500px",fixedcenter:true,modal:true,visible:true,draggable:true,buttons:[{text:"OK - Invite these People",handler:submitGroupInvite},{text:"Cancel",handler:function(){this.destroy()}}]});B.setHeader("Invite to Group by Email");B.setBody('<div id="inviteDlgBody"><p>Enter Email Addresses to invite to this Group:</p><ol id="emailInputs"><li><input class="inviteEmail" type="text" value=""/></li></ol></div>');B.render(document.body);var A=el("inviteEmailsDlg").getElementsByClassName("inviteEmail")[0];el(A).on("keydown",function(C){checkAddEmptyEmailField(C,el(A))});setTimeout(function(){A.select();A.focus();el("inviteEmailsDlg").getElementsByClassName("container-close")[0].tabIndex=30},0)})}function submitGroupInvite(){var dlg=this;var emails=[];var inps=el("inviteEmailsDlg").getElementsByClassName("inviteEmail");for(var i=0;i<inps.length;++i){var inp=inps[i];if(el(inp).hasClass("pending")){continue}if(inp.value.replace(/[ \t]/,"")==""){continue}emails.push(inps[i].value)}if(emails.length==0){alert("Please enter one or more email addresses to send to!");return }var url="send_group_invites.php?&enc="+hex_sha1(getCookie("mc"));YAHOO.util.Connect.asyncRequest("POST",url,{success:function(req,resp,payload){log("got response: "+req.responseText);var obj=eval("x = "+req.responseText);if(obj.status=="ok"){alert("Email invites have been sent!");groupTableManager.requery();dlg.destroy()}else{alert("An error occurred while sending invitation emails: "+obj.error)}},failure:function(){alert("A problem occurred sending invitation emails.")}},"emails="+encodeURIComponent(emails.join(",")))}function checkAddEmptyEmailField(F,E){var D=YAHOO.util.Event.getCharCode(F);if(D==9){return }E.removeClass("pending");var B=el("inviteEmailsDlg").getElementsByClassName("pending");if(B.length>0){return }var C=el(document.createElement("input"),{className:"inviteEmail pending",type:"text",value:"tab to enter additional address"});var A=el(document.createElement("li"),{});A.appendChild(C);el("emailInputs").appendChild(A);C.on("focus",function(){initEmailField(C)})}function initEmailField(A){log("init");A.unsubscribeAll("focus");A.get("element").focus();A.get("element").select();A.on("keydown",function(B){checkAddEmptyEmailField(B,A)})}function checkDeleteSelf(B){log("checking accids to be deleted ...");for(var A=0;A<B.length;++A){log("deleting accid "+B[A]);if(B[A]==user.accid){return confirm("You are removing yourself from your active group.\n\nIf you continue, you will lose access to the group and will no longer be able to add or remove members.\n\nAre you sure you want to continue?")}}return true}function checkSelfDeleted(B){log("checking accids to be deleted ...");for(var A=0;A<B.length;++A){log("deleting accid "+B[A]);if(B[A]==user.accid){location.href="?page=groups"}}}function confirmAddGroup(C){var A="query_address_details.php?accid="+encodeURIComponent(C)+"&enc="+hex_sha1(getCookie("mc"));var B=YAHOO.util.Connect.asyncRequest("GET",A,{success:function(D,F,E){if(D.responseText.match(/^\s*Failed\s*$/)){alert("The account you entered could not be found.\n\nPlease check your entry and try again.");return }yuiLoader().insert(function(){var G=new YAHOO.widget.SimpleDialog("confirmAddressDlg",{width:"500px",fixedcenter:true,modal:true,visible:true,draggable:true,buttons:[{text:"OK - Add this Person",handler:function(){addGroupMember(C,this)}},{text:"Cancel",handler:function(){this.destroy()}}]});G.setHeader("Add Group Member - Confirmation");G.setBody("<p>Do you want to add the following person to this Group?</p><br/>"+D.responseText);G.render(document.body)})}})}function addGroupMember(accid,dlg){$("groupmsg").innerHTML="";var url="add_group_member.php?enc="+hex_sha1(getCookie("mc"))+"&accid="+encodeURIComponent(accid);YAHOO.util.Connect.asyncRequest("GET",url,{success:function(req,resp,payload){var obj=eval("x = "+req.responseText);if(obj.status!="ok"){alert("An error occurred while adding the group member: "+obj.error)}else{$("maccid").value="";groupTableManager.requery()}dlg.destroy()}},null);return false}function changeGroupName(){var A="change_group_name.php?enc="+hex_sha1(getCookie("mc"));YAHOO.util.Connect.asyncRequest("POST",A,{success:function(B,D,C){$("updatedMsg").style.display="inline";YAHOO.util.Dom.setStyle("updatedMsg","opacity",1);window.setTimeout(function(){var E=new YAHOO.util.Anim($("updatedMsg"),{opacity:{from:1,to:0}},0.5);E.animate()},3000)}},"name="+encodeURIComponent($("groupName").value))};